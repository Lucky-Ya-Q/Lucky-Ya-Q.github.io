---
title: 门户网站登录
date: 2022-07-18 21:44:20
permalink: /pages/213d44/
article: false
---

在 `ruoyi-common` 模块中新建 `PortalSysUser` 文件

```java
/**
 * 门户网站用户对象
 */
@Data
public class PortalSysUser {
    private Long userId;
    private String userName;
    private String password;
}
```

复制 `ruoyi-common` 模块中 `LoginUser` 文件重命名为 `PortalLoginUser` 并修改代码

```java
// SysUser 替换为 PortalSysUser
```

在 `ruoyi-common` 模块中新建 `PortalSecurityUtils` 文件

```java
public class PortalSecurityUtils {
    public static Long getUserId() {
        try {
            return getPortalLoginUser().getUserId();
        } catch (Exception e) {
            throw new ServiceException("获取用户ID异常", HttpStatus.UNAUTHORIZED);
        }
    }

    public static String getUsername() {
        try {
            return getPortalLoginUser().getUsername();
        } catch (Exception e) {
            throw new ServiceException("获取用户账户异常", HttpStatus.UNAUTHORIZED);
        }
    }

    public static PortalLoginUser getPortalLoginUser() {
        try {
            return (PortalLoginUser) getAuthentication().getPrincipal();
        } catch (Exception e) {
            throw new ServiceException("获取用户信息异常", HttpStatus.UNAUTHORIZED);
        }
    }

    public static Authentication getAuthentication() {
        return SecurityContextHolder.getContext().getAuthentication();
    }
}
```

复制 `ruoyi-framework` 模块中 `TokenService` 文件重命名为 `PortalTokenService` 并修改代码

```java
// LoginUser 替换为 PortalLoginUser
// LOGIN_USER_KEY 替换为 PORTAL_LOGIN_USER_KEY
// TOKEN_PREFIX 替换为 PORTAL_TOKEN_PREFIX
// LOGIN_TOKEN_KEY 替换为 PORTAL_LOGIN_TOKEN_KEY
```

## 修改认证过滤器

```java {5-6,14-28}
@Component
public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {
    @Autowired
    private TokenService tokenService;
    @Autowired
    private PortalTokenService portalTokenService;

    /**
     * 使用 anonymous 或 permitAll 放行的资源也会经过此方法
     */
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)
            throws ServletException, IOException {
        LoginUser loginUser = tokenService.getLoginUser(request);
        if (StringUtils.isNotNull(loginUser) && StringUtils.isNull(SecurityUtils.getAuthentication())) {
            tokenService.verifyToken(loginUser);
            UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginUser, null, loginUser.getAuthorities());
            authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
            SecurityContextHolder.getContext().setAuthentication(authenticationToken);
        }
        PortalLoginUser portalLoginUser = portalTokenService.getPortalLoginUser(request);
        if (StringUtils.isNotNull(portalLoginUser) && StringUtils.isNull(SecurityUtils.getAuthentication())) {
            portalTokenService.verifyToken(portalLoginUser);
            UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(portalLoginUser, null, portalLoginUser.getAuthorities());
            authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
            SecurityContextHolder.getContext().setAuthentication(authenticationToken);
        }
        chain.doFilter(request, response);
    }
}
```

## 修改退出处理类

```java {5-6,14-27}
@Configuration
public class LogoutSuccessHandlerImpl implements LogoutSuccessHandler {
    @Autowired
    private TokenService tokenService;
    @Autowired
    private PortalTokenService portalTokenService;

    /**
     * 退出处理
     */
    @Override
    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication)
            throws IOException, ServletException {
        LoginUser loginUser = tokenService.getLoginUser(request);
        if (StringUtils.isNotNull(loginUser)) {
            String userName = loginUser.getUsername();
            // 删除用户缓存记录
            tokenService.delLoginUser(loginUser.getToken());
            // 记录用户退出日志
            AsyncManager.me().execute(AsyncFactory.recordLogininfor(userName, Constants.LOGOUT, "退出成功"));
        }
        PortalLoginUser portalLoginUser = portalTokenService.getPortalLoginUser(request);
        if (StringUtils.isNotNull(portalLoginUser)) {
            // 删除用户缓存记录
            portalTokenService.delPortalLoginUser(portalLoginUser.getToken());
        }
        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.error(HttpStatus.SUCCESS, "退出成功")));
    }
}
```

## 放行登录接口

```java
@RestController
@RequestMapping("/portal")
public class PortalSysLoginController {
    @Autowired
    private PortalTokenService portalTokenService;

    @Anonymous
    @PostMapping("/login")
    public AjaxResult login(@RequestBody PortalSysUser portalSysUser) {
        if ("admin".equals(portalSysUser.getUserName()) && "admin123".equals(portalSysUser.getPassword())) {
            portalSysUser.setUserId(1L);

            PortalLoginUser portalLoginUser = new PortalLoginUser();
            portalLoginUser.setUser(portalSysUser);
            String token = portalTokenService.createToken(portalLoginUser);
            return AjaxResult.success().put(Constants.TOKEN, token);
        } else {
            return AjaxResult.error(MessageUtils.message("user.password.not.match"));
        }
    }

    @GetMapping("/getInfo")
    public AjaxResult getInfo() {
        PortalSysUser user = PortalSecurityUtils.getPortalLoginUser().getUser();
        return AjaxResult.success().put("user", user);
    }
}
```

## 测试功能

登录：http://127.0.0.1:8080/portal/login

```json
{
	"userName": "admin",
	"password": "admin123"
}
```

获取用户信息：http://127.0.0.1:8080/portal/getInfo

| 参数名        | 参数值       |
| ------------- | ------------ |
| Authorization | Portal token |

退出登录（没登录也能调用）：http://127.0.0.1:8080/logout
