---
title: 门户网站登录
date: 2022-07-18 21:44:20
permalink: /pages/213d44/
article: false
---

在 `ruoyi-common` 模块中新建 `PortalSysUser` 文件

```java
@Data
public class PortalSysUser {
    private Long userId;
    private String username;
}
```

复制 `ruoyi-common` 模块中 `LoginUser` 文件重命名为 `PortalLoginUser` 并修改代码

```java
// SysUser 替换为 PortalSysUser
```

在 `ruoyi-common` 模块中新建 `PortalSecurityUtils` 文件

```java
public class PortalSecurityUtils {
    public static Long getUserId() {
        try {
            return getPortalLoginUser().getUserId();
        } catch (Exception e) {
            throw new ServiceException("获取用户ID异常", HttpStatus.UNAUTHORIZED);
        }
    }

    public static String getUsername() {
        try {
            return getPortalLoginUser().getUsername();
        } catch (Exception e) {
            throw new ServiceException("获取用户账户异常", HttpStatus.UNAUTHORIZED);
        }
    }

    public static PortalLoginUser getPortalLoginUser() {
        try {
            return (PortalLoginUser) getAuthentication().getPrincipal();
        } catch (Exception e) {
            throw new ServiceException("获取用户信息异常", HttpStatus.UNAUTHORIZED);
        }
    }

    public static Authentication getAuthentication() {
        return SecurityContextHolder.getContext().getAuthentication();
    }
}
```

## 修改认证处理类

删除 `header` 属性，删除 `获取请求token` 方法，修改 `获取用户身份信息` 方法

```java
public LoginUser getLoginUser(String token) {
    try {
        Claims claims = parseToken(token);
        // 解析对应的权限以及用户信息
        String uuid = (String) claims.get(Constants.LOGIN_USER_KEY);
        String userKey = getTokenKey(uuid);
        return redisCache.getCacheObject(userKey);
    } catch (Exception e) {
        e.printStackTrace();
    }
    return null;
}
```

复制 `ruoyi-framework` 模块中 `TokenService` 文件重命名为 `PortalTokenService` 并修改代码

```java
// LoginUser 替换为 PortalLoginUser
```

## 修改认证过滤器

```java {3-5,14-39}
@Component
public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {
    // 令牌自定义标识
    @Value("${token.header}")
    private String header;
    @Autowired
    private TokenService tokenService;
    @Autowired
    private PortalTokenService portalTokenService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)
            throws ServletException, IOException {
        String token = request.getHeader(header);
        if (StringUtils.isNotEmpty(token)) {
            if (token.startsWith(Constants.TOKEN_PREFIX)) {
                token = token.replace(Constants.TOKEN_PREFIX, "");

                LoginUser loginUser = tokenService.getLoginUser(token);
                if (StringUtils.isNotNull(loginUser) && StringUtils.isNull(SecurityUtils.getAuthentication())) {
                    tokenService.verifyToken(loginUser);
                    UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginUser, null, loginUser.getAuthorities());
                    authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);
                }
            } else if (token.startsWith(Constants.PORTAL_TOKEN_PREFIX)) {
                token = token.replace(Constants.PORTAL_TOKEN_PREFIX, "");

                PortalLoginUser portalLoginUser = portalTokenService.getPortalLoginUser(token);
                if (StringUtils.isNotNull(portalLoginUser) && StringUtils.isNull(PortalSecurityUtils.getAuthentication())) {
                    portalTokenService.verifyToken(portalLoginUser);
                    UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(portalLoginUser, null, portalLoginUser.getAuthorities());
                    authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);
                }
            } else {
                throw new ServiceException("令牌前缀有误");
            }
        }
        chain.doFilter(request, response);
    }
}
```

## 修改退出处理类

```java {3-5,19-43}
@Configuration
public class LogoutSuccessHandlerImpl implements LogoutSuccessHandler {
    // 令牌自定义标识
    @Value("${token.header}")
    private String header;
    @Autowired
    private TokenService tokenService;
    @Autowired
    private PortalTokenService portalTokenService;

    /**
     * 退出处理
     *
     * @return
     */
    @Override
    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication)
            throws IOException, ServletException {
        String token = request.getHeader(header);
        if (StringUtils.isNotEmpty(token)) {
            if (token.startsWith(Constants.TOKEN_PREFIX)) {
                token = token.replace(Constants.TOKEN_PREFIX, "");

                LoginUser loginUser = tokenService.getLoginUser(token);
                if (StringUtils.isNotNull(loginUser)) {
                    String userName = loginUser.getUsername();
                    // 删除用户缓存记录
                    tokenService.delLoginUser(loginUser.getToken());
                    // 记录用户退出日志
                    AsyncManager.me().execute(AsyncFactory.recordLogininfor(userName, Constants.LOGOUT, "退出成功"));
                }
            } else if (token.startsWith(Constants.PORTAL_TOKEN_PREFIX)) {
                token = token.replace(Constants.PORTAL_TOKEN_PREFIX, "");

                PortalLoginUser portalLoginUser = portalTokenService.getPortalLoginUser(token);
                if (StringUtils.isNotNull(portalLoginUser)) {
                    // 删除用户缓存记录
                    portalTokenService.delPortalLoginUser(portalLoginUser.getToken());
                }
            } else {
                throw new ServiceException("令牌前缀有误");
            }
        }
        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.error(HttpStatus.SUCCESS, "退出成功")));
    }
}
```

## 放行登录接口

```java
@RestController
@RequestMapping("/portal")
public class PortalSysLoginController {
    @Autowired
    private PortalTokenService portalTokenService;

    @Anonymous
    @PostMapping("/login")
    public AjaxResult login(@RequestBody PortalSysUser portalSysUser) {
        PortalLoginUser portalLoginUser = new PortalLoginUser();
        portalLoginUser.setUser(portalSysUser);
        String token = portalTokenService.createToken(portalLoginUser);
        return AjaxResult.success().put(Constants.TOKEN, token);
    }

    @GetMapping("/getInfo")
    public AjaxResult getInfo() {
        PortalSysUser user = PortalSecurityUtils.getPortalLoginUser().getUser();
        return AjaxResult.success().put("user", user);
    }
}
```

## 测试功能

用户登录：http://127.0.0.1:8080/portal/login

```json
{
	"userId": 1,
	"username": "管理员"
}
```



| 参数名        | 参数值                                                       |
| ------------- | ------------------------------------------------------------ |
| Authorization | Portal eyJhbGciOiJIUzUxMiJ9.eyJwb3J0YWxfbG9naW5fdXNlcl9rZXkiOiIzOWY3MmE5NS1mNGQzLTQzMTYtYjM3Yi04ZDIyNzNmOGRjZjIifQ.RVp101WWysR-e2PjnYdZyuCptFGd_RzGxIiRUvgIyl_UNMTskDDa2I0Mqya7UQ76OKuDPKBfXEcv_zjwX_gbpQ |

获取用户信息：http://127.0.0.1:8080/portal/getInfo

退出登录：http://127.0.0.1:8080/logout
